#!/bin/bash
#PBS -N tsp_test_quick
#PBS -q b_8cores_1h
#PBS -l nodes=1:ppn=8
#PBS -l walltime=01:00:00
#PBS -o logs/test_quick_output.log
#PBS -e logs/test_quick_error.log

cd $PBS_O_WORKDIR

echo "=== TSP TESTE RÁPIDO ==="
echo "Job ID: $PBS_JOBID"
echo "Data: $(date)"
echo "Nó: $(hostname)"
echo ""

# Compilar programas
echo "=== COMPILAÇÃO ==="
gcc -O3 -fopenmp -lm src/tsp_omp.c -o bin/tsp_omp
echo "✓ OpenMP compilado"

mpicc -O3 -lm src/tsp_mpi.c -o bin/tsp_mpi  
echo "✓ MPI compilado"

# Arquivo de teste
TEST_FILE="data/berlin52.tsp"
echo "Arquivo de teste: $TEST_FILE"
echo ""

# Arquivo de resultados
RESULT_FILE="results/test_quick_$(date +%H%M%S).csv"
echo "algorithm,threads,speedup,time_total" > $RESULT_FILE

echo "=== TESTE OPENMP ==="
for threads in 1 2 4 8; do
    echo "Testando OpenMP com $threads threads..."
    export OMP_NUM_THREADS=$threads
    
    output=$(./bin/tsp_omp $TEST_FILE)
    speedup=$(echo "$output" | grep "Speedup:" | awk '{print $2}' | tr -d 'x')
    time_total=$(echo "$output" | grep "Tempo Paralelo:" | awk '{print $3}')
    
    echo "OpenMP,$threads,$speedup,$time_total" >> $RESULT_FILE
    echo "  Speedup: ${speedup}x"
done

echo ""
echo "=== TESTE MPI ==="
for procs in 1 2 4 8; do
    echo "Testando MPI com $procs processos..."
    
    output=$(mpirun -np $procs bin/tsp_mpi $TEST_FILE)
    speedup=$(echo "$output" | grep "Speedup:" | awk '{print $2}' | tr -d 'x')
    time_total=$(echo "$output" | grep "Tempo Paralelo:" | awk '{print $3}')
    
    echo "MPI,$procs,$speedup,$time_total" >> $RESULT_FILE
    echo "  Speedup: ${speedup}x"
done

echo ""
echo "=== RESULTADOS ==="
cat $RESULT_FILE

echo ""
echo "=== TESTE CONCLUÍDO ==="
echo "Arquivo salvo: $RESULT_FILE"
echo "Fim: $(date)"